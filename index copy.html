<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Amplification Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="../css/leaflet-sidebar.css" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
  <style>
    body, html, #map {
      height: 100%;
      margin: 0;
      font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
    }
    .sidebar-card {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }
    .sidebar-card img {
      width: 100%;
      max-height: 150px;
      object-fit: cover;
      margin-bottom: 5px;
    }
    .lorem { font-style: italic; color: #aaa; }
  </style>
</head>
<body>
  <div id="sidebar" class="leaflet-sidebar">
    <div class="leaflet-sidebar-tabs">
      <ul role="tablist">
        <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
        <li><a href="#about" role="tab"><i class="fa fa-user"></i></a></li>
      </ul>
    </div>
    <div class="leaflet-sidebar-content">
      <div class="leaflet-sidebar-pane" id="home">
        <h1 class="leaflet-sidebar-header">
          Artworks associated with the location
          <span class="leaflet-sidebar-close"><i class="fa fa-caret-right"></i></span>
        </h1>
        <div class="sidebar-menu"></div>
      </div>
      <div class="leaflet-sidebar-pane" id="about">
        <h1 class="leaflet-sidebar-header">
          About<span class="leaflet-sidebar-close"><i class="fa fa-caret-right"></i></span>
        </h1>
        <div class="sidebar-menu">
          <p><strong>A spatial interface for exploring the Amplification Project’s digital archive.</strong></p>
          <p>This project is a narrative-driven interactive web map built with Leaflet, visualizing 76 artworks from the Amplification Project archive based on associated geographic metadata. It is structured on the leaflet-sidebar-v2 template. The map enables users to explore artworks by geographic reference—whether that's the site of creation, exhibition, or thematic relevance.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="../js/leaflet-sidebar.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    const map = L.map("map", { zoomControl: false }).setView([41, -74], 3);
    const highlightColor = "#508e88";
    const connectionLines = L.layerGroup().addTo(map);
    const sidebar = L.control.sidebar({ container: "sidebar", position: "left" }).addTo(map).open("about");
    const sidebarMenu = document.querySelector("#home .sidebar-menu");

    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; Stadia Maps, OpenMapTiles & OpenStreetMap',
      maxZoom: 20
    }).addTo(map);

    const works = [];
    const locationLookup = {};

    function loadLocationCoords() {
      return new Promise(resolve => {
        Papa.parse('./data/countryCords.csv', {
          header: true,
          download: true,
          complete: function(results) {
            results.data.forEach(row => {
              if (row.name && row.lat && row.lng) {
                locationLookup[row.name.trim()] = [parseFloat(row.lat), parseFloat(row.lng)];
              }
            });
            resolve();
          }
        });
      });
    }

    function loadWorksAndLayers() {
      Papa.parse('./data/cleaned_data_2025-05-07.csv', {
        header: true,
        download: true,
        complete: function(results) {
          results.data.forEach(row => {
            const entry = {
              title: row.Title,
              author: row.Author,
              publishedOn: row["Published On"],
              slug: row.Slug,
              img: row.Cover_img,
              countries: Object.keys(row)
                .filter(k => k.startsWith("country") && row[k] && !["United States", "United States of America"].includes(row[k]))
                .map(k => row[k]),
              states: Object.keys(row).filter(k => k.startsWith("state") && row[k]).map(k => row[k])
            };
            works.push(entry);
          });
          loadShapeLayers();
        }
      });
    }

    function loadShapeLayers() {
      fetch('./mapLayers/countries.geojson')
        .then(res => res.json())
        .then(countryData => {
          L.geoJSON(countryData, {
            style: feature => {
              const name = feature.properties.name;
              const match = works.some(w =>
                w.countries.includes(name) || w.states.includes(name)
              );
              return {
                fillColor: match && name !== "United States" && name !== "United States of America" ? highlightColor : "transparent",
                color: "#ccc",
                weight: 1,
                fillOpacity: match ? 0.5 : 0
              };
            },
            onEachFeature: (feature, layer) => {
              const name = feature.properties.name;
              if (name === "United States" || name === "United States of America") return;
              layer.on("click", () => {
                showWorksByRegion(name);
              });
            }
          }).addTo(map);
        });

      fetch('./mapLayers/state.json')
        .then(res => res.json())
        .then(stateData => {
          L.geoJSON(stateData, {
            style: feature => {
              const name = feature.properties.NAME;
              const match = works.some(w => w.states.includes(name));
              return {
                fillColor: match ? highlightColor : "transparent",
                color: "#ccc",
                weight: 1,
                fillOpacity: match ? 0.5 : 0
              };
            },
            onEachFeature: (feature, layer) => {
              const name = feature.properties.NAME;
              layer.on("click", () => {
                showWorksByRegion(name);
              });
            }
          }).addTo(map);
        });
    }

    function showWorksByRegion(regionName) {
      sidebarMenu.innerHTML = `<h4>Works in ${regionName}</h4>`;
      connectionLines.clearLayers();

      const matched = works.filter(work =>
        work.states.includes(regionName) || work.countries.includes(regionName)
      );

      if (matched.length === 0) {
        sidebarMenu.innerHTML += "<p class='lorem'>No works found in this region.</p>";
        return;
      }

      matched.forEach(work => {
        const card = document.createElement("div");
        card.className = "sidebar-card";
        card.innerHTML = `
          <a href="https://www.theamplificationproject.org/projects/${work.slug}" target="_blank">
            <img src="${work.img}" alt="${work.title}">
            <strong>${work.title}</strong><br/>
            <em>By ${work.author}</em><br/>
            <small>Published On: ${work.publishedOn}</small>
          </a>
        `;
        sidebarMenu.appendChild(card);

        const linkedPlaces = [...work.states, ...work.countries]
          .filter(name => name !== regionName && locationLookup[name]);

        linkedPlaces.forEach(dest => {
          const from = locationLookup[regionName];
          const to = locationLookup[dest];
          if (from && to) {
            const line = L.polyline([from, to], {
              color: highlightColor,
              weight: 1.5,
              opacity: 0.6,
              dashArray: "4"
            });
            connectionLines.addLayer(line);
          }
        });
      });

      sidebar.open("home");
    }

    loadLocationCoords().then(loadWorksAndLayers);
  </script>
</body>
</html>
